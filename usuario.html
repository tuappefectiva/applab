<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Usuario – Laboratorio (con Ubicación y Catálogo)</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --primary:#2563eb; --primary-600:#1d4ed8; --danger:#ef4444; --success:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:var(--bg)}
    .container{max-width:1100px; margin:28px auto; padding:0 16px}
    h1{margin:0 0 6px 0; font-size:26px}
    p.muted{color:var(--muted); margin:0 0 18px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:repeat(12,1fr)}}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
    .span-4{grid-column:span 12}
    .span-6{grid-column:span 12}
    .span-8{grid-column:span 12}
    .span-12{grid-column:span 12}
    @media(min-width:900px){
      .span-4{grid-column:span 4}
      .span-6{grid-column:span 6}
      .span-8{grid-column:span 8}
      .span-12{grid-column:span 12}
    }
    h2{margin:0 0 12px 0; font-size:18px}
    .row{display:flex; flex-wrap:wrap; gap:12px}
    .field{display:flex; flex-direction:column; gap:6px; min-width:200px; flex:1}
    label{font-size:12px; color:var(--muted)}
    input[type=text], input[type=number], select, textarea{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff
    }
    select[size]{padding:8px}
    .btn{appearance:none; background:var(--primary); color:#fff; border:1px solid transparent; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600}
    .btn:hover{background:var(--primary-600)}
    .btn-ghost{background:transparent; color:var(--text); border-color:var(--border)}
    .btn-danger{background:var(--danger)}
    .btn-inline{align-self:flex-end; flex:0}

    .list{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px}
    .item{display:flex; justify-content:space-between; align-items:center; gap:12px; border:1px solid var(--border); border-radius:10px; padding:10px}
    .item-ubicacion{background:#f9fafb}
    .muted{color:var(--muted)}
    .badge{display:inline-block; border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fafafa; font-size:12px}
    .notice{font-size:12px; color:var(--muted); margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Usuario – Laboratorio</h1>
    <p class="muted">Busca o agrega productos, selecciona la ubicación y envía el pedido al área de administración.</p>

    <main class="grid">
      <!-- A) Buscar producto (placeholder para tu futuro buscador) -->
      <section class="card span-6" aria-labelledby="tit-buscar">
        <h2 id="tit-buscar">Buscar producto</h2>
        <div class="row">
          <div class="field" style="flex:2">
            <label for="q">Nombre o código</label>
            <input id="q" type="text" placeholder="Ej.: Puntas 200 µL o 12-345" />
          </div>
          <div class="field btn-inline">
            <button type="button" class="btn btn-ghost" id="btn-buscar">Buscar</button>
          </div>
        </div>
        <p class="notice">*Conecta aquí tu lógica de búsqueda propia cuando esté lista.</p>
      </section>

      <!-- B) Agregar productos manualmente -->
      <section class="card span-6" aria-labelledby="tit-manual">
        <h2 id="tit-manual">Agregar productos manualmente</h2>
        <div class="row">
          <div class="field">
            <label for="m-nombre">Nombre del producto</label>
            <input id="m-nombre" type="text" placeholder="Ej.: Guantes nitrilo" />
          </div>
          <div class="field">
            <label for="m-codigo">Código</label>
            <input id="m-codigo" type="text" placeholder="Opcional" />
          </div>
          <div class="field" style="max-width:160px">
            <label for="m-cantidad">Cantidad</label>
            <input id="m-cantidad" type="number" min="1" value="1" />
          </div>
          <div class="field btn-inline">
            <button type="button" class="btn" id="btn-add-manual">Añadir a la lista</button>
          </div>
        </div>
      </section>

      <!-- C) NUEVO: Catálogo desde productos_usuario_limpio.json -->
      <section class="card span-8" aria-labelledby="tit-catalogo">
        <h2 id="tit-catalogo">Catálogo (productos_usuario_limpio.json)</h2>

        <div class="row">
          <div class="field" style="flex:2">
            <label for="filtro">Filtrar por nombre o código</label>
            <input id="filtro" type="text" placeholder="Escribe para filtrar…" />
          </div>
          <div class="field" style="max-width:160px">
            <label for="cat-cantidad">Cantidad</label>
            <input id="cat-cantidad" type="number" min="1" value="1" />
          </div>
          <div class="field btn-inline">
            <button type="button" class="btn" id="btn-add-catalogo">Añadir seleccionado</button>
          </div>
        </div>

        <div class="row">
          <div class="field" style="flex:2">
            <label for="catalogo-lista">Resultados</label>
            <select id="catalogo-lista" size="8"></select>
          </div>

          <div class="field" style="flex:1">
            <label for="catalogo-file">Si no se carga automáticamente, carga el archivo aquí</label>
            <input id="catalogo-file" type="file" accept=".json,.txt" />
            <p class="notice" id="catalogo-msg">Intentando cargar <code>productos_usuario_limpio.json</code>…</p>
          </div>
        </div>
      </section>

      <!-- D) Ubicación del solicitante -->
      <section class="card span-4" aria-labelledby="tit-ubicacion" id="card-ubicacion">
        <h2 id="tit-ubicacion">Ubicación del solicitante</h2>
        <div class="row">
          <div class="field">
            <label for="sel-ubicacion">Selecciona ubicación</label>
            <select id="sel-ubicacion">
              <option value="" selected>— Selecciona —</option>
              <option value="Almería">Almería</option>
              <option value="Águilas">Águilas</option>
            </select>
          </div>
          <div class="field btn-inline">
            <button type="button" class="btn" id="btn-add-ubicacion">Añadir ubicación</button>
          </div>
        </div>
        <p class="notice">Pulsa <strong>“Añadir ubicación”</strong> para que se muestre en <em>Productos seleccionados</em> y viaje con el pedido.</p>
      </section>

      <!-- E) Productos seleccionados -->
      <section class="card span-12" aria-labelledby="tit-seleccion">
        <h2 id="tit-seleccion">Productos seleccionados</h2>
        <ul class="list" id="lista-productos"></ul>
        <div style="display:flex; gap:12px; margin-top:12px">
          <button type="button" class="btn" id="btn-hacer-pedido">Hacer pedido</button>
          <button type="button" class="btn btn-ghost" id="btn-vaciar">Vaciar selección</button>
        </div>
        <p id="msg" class="muted" style="margin-top:8px"></p>
      </section>
    </main>
  </div>

  <script>
    // ------------------------------
    // Estado
    // ------------------------------
    let productos = [];                 // {id, nombre, codigo, cantidad}
    let ubicacion = '';                 // Ubicación confirmada (aparece en lista)
    let ubicacionSeleccionada = '';     // Selección provisional en el select
    let catalogo = [];                  // {nombre, codigo}
    let catalogoFiltrado = [];          // vista filtrada

    // ------------------------------
    // Elementos
    // ------------------------------
    const elLista = document.getElementById('lista-productos');
    const elMsg = document.getElementById('msg');

    const elFiltro = document.getElementById('filtro');
    const elCatLista = document.getElementById('catalogo-lista');
    const elCatCantidad = document.getElementById('cat-cantidad');
    const elCatMsg = document.getElementById('catalogo-msg');
    const elCatFile = document.getElementById('catalogo-file');

    // ------------------------------
    // Utilidades
    // ------------------------------
    const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()));

    function render(){
      elLista.innerHTML = '';

      // (1) Ubicación como primer ítem
      if (ubicacion){
        const liU = document.createElement('li');
        liU.className = 'item item-ubicacion';
        liU.innerHTML = `<div><strong>Ubicación del solicitante:</strong> ${ubicacion}</div>`;
        elLista.appendChild(liU);
      }

      // (2) Productos
      if (productos.length === 0){
        const li = document.createElement('li');
        li.className = 'item';
        li.innerHTML = '<span class="muted">No hay productos en la lista.</span>';
        elLista.appendChild(li);
      } else {
        for (const p of productos){
          const li = document.createElement('li');
          li.className = 'item';
          const left = document.createElement('div');
          left.innerHTML = `<strong>${p.nombre}</strong> <span class="muted">${p.codigo ? '· ' + p.codigo + ' · ' : ''}x${p.cantidad}</span>`;
          const btn = document.createElement('button');
          btn.className = 'btn btn-danger';
          btn.textContent = 'Eliminar';
          btn.addEventListener('click', () => removeProducto(p.id));
          li.appendChild(left); li.appendChild(btn); elLista.appendChild(li);
        }
      }
    }

    function removeProducto(id){
      productos = productos.filter(p => p.id !== id);
      render();
    }

    function normaliza(str){
      return String(str || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\\u0300-\\u036f]/g, ''); // quita tildes
    }

    function parseCatalog(texto){
      // El archivo viene como texto plano: "nombre ... codigo ... nombre ... codigo ..."
      // Extraemos pares con regex robusta.
      const rx = /nombre\\s+(.*?)\\s+codigo\\s+([^\\s\\n]+)(?=\\s+nombre\\s+|$)/gsi;
      const items = [];
      let m;
      while ((m = rx.exec(texto)) !== null){
        const nombre = m[1].trim().replace(/\\s+/g, ' ');
        const codigo = m[2].trim();
        if (nombre) items.push({ nombre, codigo });
      }
      return items;
    }

    function renderCatalog(filtro = ''){
      const f = normaliza(filtro);
      elCatLista.innerHTML = '';
      catalogoFiltrado = (f ? catalogo.filter(x =>
        normaliza(x.nombre).includes(f) || normaliza(x.codigo).includes(f)
      ) : catalogo);

      if (catalogoFiltrado.length === 0){
