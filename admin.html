<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Administraci√≥n ‚Äî Pedidos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      color: #333;
      padding: 20px;
    }
    h1 {
      color: #004832;
    }
    .pedido {
      background-color: #ffffff;
      border-left: 5px solid #004832;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .pedido h3 {
      margin-top: 0;
    }
    .ubicacion {
      display: inline-block;
      background-color: #b9e6b9;
      color: #004832;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    .fecha {
      color: #666;
      font-size: 12px;
      font-style: italic;
    }
    ul {
      padding-left: 20px;
    }
    .btn-eliminar {
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 5px 10px;
      cursor: pointer;
      margin-top: 10px;
    }
    #limpiarTodo, #btnActualizar {
      background-color: #004832;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 20px;
      margin-right: 10px;
    }
    .config-info {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .config-info input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: monospace;
      font-size: 12px;
    }
    .config-info button {
      background-color: #004832;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #004832;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Pedidos realizados</h1>
  
  <div class="config-info" id="configPanel">
    <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
    <p><strong>Instrucciones:</strong></p>
    <ol>
      <li>Ve a <a href="https://jsonbin.io/" target="_blank">jsonbin.io</a> y crea una cuenta gratuita</li>
      <li>Crea un nuevo Bin y copia su ID</li>
      <li>Ve a "API Keys" y crea una clave con permisos de lectura y escritura</li>
      <li>Pega los mismos datos que usaste en usuario.html:</li>
    </ol>
    <label>BIN ID:</label>
    <input type="text" id="binId" placeholder="Ej: 673a1b2c3d4e5f6g7h8i9j0k" />
    <label>API KEY:</label>
    <input type="password" id="apiKey" placeholder="Tu API Key de JSONBin" />
    <button onclick="guardarConfig()">üíæ Guardar Configuraci√≥n</button>
  </div>

  <button id="btnActualizar" onclick="cargarPedidos()">üîÑ Actualizar</button>
  <button id="limpiarTodo">üóëÔ∏è Limpiar todos los pedidos</button>
  
  <div id="zonaPedidos"></div>

  <script>
    const CONFIG_KEY = 'jsonbin_config';
    let config = null;

    function cargarConfiguracion() {
      const stored = localStorage.getItem(CONFIG_KEY);
      if (stored) {
        config = JSON.parse(stored);
        document.getElementById('binId').value = config.binId;
        document.getElementById('apiKey').value = config.apiKey;
        document.getElementById('configPanel').style.display = 'none';
      }
    }

    function guardarConfig() {
      const binId = document.getElementById('binId').value.trim();
      const apiKey = document.getElementById('apiKey').value.trim();
      
      if (!binId || !apiKey) {
        alert('Por favor completa ambos campos');
        return;
      }
      
      config = { binId, apiKey };
      localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
      document.getElementById('configPanel').style.display = 'none';
      alert('‚úÖ Configuraci√≥n guardada correctamente');
      cargarPedidos();
    }

    async function cargarPedidos() {
      if (!config || !config.binId || !config.apiKey) {
        alert('‚ö†Ô∏è Por favor configura primero el sistema con tu BIN ID y API KEY');
        return;
      }

      const zona = document.getElementById('zonaPedidos');
      zona.innerHTML = '<div class="loading">‚è≥ Cargando pedidos...</div>';

      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${config.binId}/latest`, {
          headers: {
            'X-Access-Key': config.apiKey
          }
        });

        if (!response.ok) {
          throw new Error('Error al cargar pedidos');
        }

        const data = await response.json();
        const pedidos = data.record.pedidos || [];

        zona.innerHTML = '';

        if (pedidos.length === 0) {
          zona.innerHTML = '<p>No hay pedidos registrados.</p>';
          return;
        }

        pedidos.forEach((pedido, index) => {
          const div = document.createElement('div');
          div.className = 'pedido';

          const encabezado = document.createElement('h3');
          encabezado.textContent = `Pedido #${index + 1} ‚Äî Semana ${pedido.semana}, ${pedido.anio}`;
          
          if (pedido.ubicacion) {
            const spanUbicacion = document.createElement('span');
            spanUbicacion.className = 'ubicacion';
            spanUbicacion.textContent = pedido.ubicacion;
            encabezado.appendChild(spanUbicacion);
          }
          
          div.appendChild(encabezado);

          if (pedido.fecha) {
            const fecha = document.createElement('div');
            fecha.className = 'fecha';
            fecha.textContent = `Fecha: ${new Date(pedido.fecha).toLocaleString('es-ES')}`;
            div.appendChild(fecha);
          }

          const lista = document.createElement('ul');
          pedido.productos.forEach(prod => {
            const li = document.createElement('li');
            li.textContent = prod;
            lista.appendChild(li);
          });
          div.appendChild(lista);

          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'Eliminar este pedido';
          btnEliminar.className = 'btn-eliminar';
          btnEliminar.onclick = () => eliminarPedido(index);
          div.appendChild(btnEliminar);

          zona.appendChild(div);
        });
      } catch (error) {
        console.error('Error:', error);
        zona.innerHTML = '<p style="color: red;">‚ùå Error al cargar pedidos. Verifica tu configuraci√≥n.</p>';
      }
    }

    async function eliminarPedido(index) {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar este pedido?')) {
        return;
      }

      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${config.binId}/latest`, {
          headers: {
            'X-Access-Key': config.apiKey
          }
        });

        const data = await response.json();
        const pedidos = data.record.pedidos || [];
        pedidos.splice(index, 1);

        const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${config.binId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Access-Key': config.apiKey
          },
          body: JSON.stringify({ pedidos })
        });

        if (updateResponse.ok) {
          cargarPedidos();
        } else {
          throw new Error('Error al eliminar');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al eliminar el pedido');
      }
    }

    document.getElementById('limpiarTodo').addEventListener('click', async () => {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar todos los pedidos?')) {
        return;
      }

      try {
        const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${config.binId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Access-Key': config.apiKey
          },
          body: JSON.stringify({ pedidos: [] })
        });

        if (updateResponse.ok) {
          cargarPedidos();
        } else {
          throw new Error('Error al limpiar');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al limpiar los pedidos');
      }
    });

    // Cargar autom√°ticamente cada 10 segundos
    setInterval(() => {
      if (config) cargarPedidos();
    }, 10000);

    cargarConfiguracion();
    if (config) cargarPedidos();
  </script>
</body>
</html>
